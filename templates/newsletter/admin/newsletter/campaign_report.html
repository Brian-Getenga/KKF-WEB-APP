{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Campaign Report - {{ campaign.title }}{% endblock %}

{% block extrastyle %}
<style>
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    .stat-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
    }
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        margin: 10px 0;
    }
    .stat-label {
        color: #6c757d;
        font-size: 14px;
        text-transform: uppercase;
    }
    .success-card { border-left: 4px solid #28a745; }
    .failed-card { border-left: 4px solid #dc3545; }
    .total-card { border-left: 4px solid #007bff; }
    .rate-card { border-left: 4px solid #ffc107; }
    
    .log-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        background: white;
    }
    .log-table th {
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        border-bottom: 2px solid #dee2e6;
        font-weight: bold;
    }
    .log-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #dee2e6;
    }
    .log-table tr:hover {
        background: #f8f9fa;
    }
    .success-badge {
        background: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
    }
    .failed-badge {
        background: #dc3545;
        color: white;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
    }
    .error-text {
        color: #dc3545;
        font-family: monospace;
        font-size: 12px;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 20px auto;">
    <h1>üìä Campaign Report: {{ campaign.title }}</h1>
    
    <div style="background: #e7f3ff; border: 1px solid #007bff; padding: 15px; border-radius: 5px; margin: 20px 0;">
        <p style="margin: 0;"><strong>Subject:</strong> {{ campaign.subject }}</p>
        <p style="margin: 5px 0;"><strong>Type:</strong> {{ campaign.get_campaign_type_display }}</p>
        <p style="margin: 5px 0;"><strong>Status:</strong> {{ campaign.get_status_display }}</p>
        <p style="margin: 5px 0;"><strong>Sent Date:</strong> {{ campaign.sent_date|date:"Y-m-d H:i:s"|default:"Not sent" }}</p>
    </div>

    <div class="stats-container">
        <div class="stat-card total-card">
            <div class="stat-label">Total Recipients</div>
            <div class="stat-value">{{ total }}</div>
        </div>
        <div class="stat-card success-card">
            <div class="stat-label">Successful</div>
            <div class="stat-value" style="color: #28a745;">{{ successful }}</div>
        </div>
        <div class="stat-card failed-card">
            <div class="stat-label">Failed</div>
            <div class="stat-value" style="color: #dc3545;">{{ failed }}</div>
        </div>
        <div class="stat-card rate-card">
            <div class="stat-label">Success Rate</div>
            <div class="stat-value" style="color: #ffc107;">{{ success_rate|floatformat:1 }}%</div>
        </div>
    </div>

    <h2 style="margin-top: 40px;">Delivery Logs</h2>
    
    {% if logs %}
        <table class="log-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Subscriber</th>
                    <th>Sent Date</th>
                    <th>Status</th>
                    <th>Error Message</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td>{{ log.id }}</td>
                    <td>
                        {% if log.subscriber %}
                            <a href="{% url 'admin:newsletter_subscriber_change' log.subscriber.id %}">
                                {{ log.subscriber.email }}
                            </a>
                        {% else %}
                            <span style="color: #dc3545;">Deleted Subscriber</span>
                        {% endif %}
                    </td>
                    <td>{{ log.sent_date|date:"Y-m-d H:i:s" }}</td>
                    <td>
                        {% if log.success %}
                            <span class="success-badge">‚úì Success</span>
                        {% else %}
                            <span class="failed-badge">‚úó Failed</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if log.error_message %}
                            <span class="error-text" title="{{ log.error_message }}">{{ log.error_message|truncatewords:10 }}</span>
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div style="background: #f8f9fa; padding: 30px; text-align: center; border-radius: 5px;">
            <p style="color: #6c757d; margin: 0;">No delivery logs found for this campaign.</p>
        </div>
    {% endif %}

    <div style="margin: 30px 0; text-align: center;">
        <a href="{% url 'admin:newsletter_campaign_changelist' %}" 
           style="background-color: #007bff; color: white; padding: 10px 25px; 
                  border-radius: 5px; text-decoration: none; display: inline-block; font-weight: bold;">
            ‚Üê Back to Campaigns
        </a>
        <a href="{% url 'admin:newsletter_campaign_change' campaign.id %}" 
           style="background-color: #28a745; color: white; padding: 10px 25px; 
                  border-radius: 5px; text-decoration: none; display: inline-block; font-weight: bold; margin-left: 10px;">
            ‚úèÔ∏è Edit Campaign
        </a>
    </div>
</div>
{% endblock %}